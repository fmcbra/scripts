#!/bin/bash

readonly LIB_PATH="$(cd $(dirname "$0")/..; pwd)/lib"
source "$LIB_PATH"/functions.bash || exit 1

function is_vm()
{
  dmesg 2>&1 \
    |grep '^.*Detected virtualization .*\.$' \
    |sed 's,^.*systemd.* Detected virtualization ,,; s,\.$,,'
}

if [[ $# -lt 1 ]]
then
  echo >&2 "Usage: $SCRIPT_NAME <command> [args...]"
  exit 1
fi

cmd="$1"
shift

case "$cmd" in
  apt-get)
    export DEBIAN_FRONTEND=noninteractive
    set --                                 \
      -yq                                  \
      -o 'Dpkg::Options::=--force-confdef' \
      -o 'Dpkg::Options::=--force-confold' \
      -o 'Dpkg::Progress-Fancy=false'      \
      -o 'APT::Color=false'                \
      "$@"
    ;;
  is-vm)
    [[ -n $(is_vm) ]] && exit 0 || exit 1
    ;;
  is-cloud)
    n=0
    for c in aws gcp azure
    do
      $0 cloud-is-$c && ((n+=1))
    done
    [[ $n -gt 0 ]] && exit 0 || exit 1
    ;;
  vm-is-xen)
    [[ $(is_vm) == xen ]] && exit 0
    exit 1
    ;;
  vm-is-kvm)
    [[ $(is_vm) == kvm ]] && exit 0
    exit 1
    ;;
  vm-is-hyperv)
    [[ $(is_vm) == microsoft ]] && exit 0
    exit 1
    ;;
  cloud-is-aws)
    grep -q '^domain .*\.compute\.internal$' /etc/resolv.conf && exit 0 || exit 1
    ;;
  cloud-is-gcp)
    grep -q '^search .*google\.internal\.$' /etc/resolv.conf && exit 0 || exit 1
    ;;
  cloud-is-azure)
    grep -q '^domain .*internal\.cloudapp\.net$' /etc/resolv.conf && exit 0 || exit 1
    ;;
  *)
    die "invalid command '$cmd'"
    ;;
esac

set -- $cmd "$@"
echo >&2 "Executing:" "$@"
exec "$@"
die "$cmd: exec failed"

##
# vim: ts=2 sw=2 et fdm=marker :
##
